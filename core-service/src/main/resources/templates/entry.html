<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/layout :: layout('이벤트 응모', null, ~{::head/content()}, ~{::section})">
<head>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { font-size: 1.2em; padding: 10px 15px; }
        #result { margin-top: 20px; font-weight: bold; }
    </style>
    <script th:inline="javascript">
        window.__AXON_TRACKER_OVERRIDES__ = {
            apiBaseUrl: 'http://localhost:8080',
            collectEndpoint: 'http://localhost:8081/api/v1/behavior/events',
            tokenProvider: () => common.getCookie('accessToken'),
            debug: true
        };
    </script>
</head>
<section>
    <h1 id="event-title">이벤트 정보 로딩 중...</h1>
    <p>아래 버튼을 눌러 이벤트에 응모하세요.</p>
    <button id="entryButton">응모하기</button>
    <div id="result"></div>

    <script th:inline="javascript">
        const params = new URLSearchParams(window.location.search);
        const campaignActivityId = params.get('campaignActivityId');

        document.addEventListener('DOMContentLoaded', function() {
            if (campaignActivityId) {
                document.getElementById('event-title').innerText = `선착순 캠페인 활동 #${campaignActivityId}`;
            } else {
                document.getElementById('event-title').innerText = '잘못된 이벤트입니다.';
                document.getElementById('entryButton').disabled = true;
            }
        });

        // 결제 준비 (1차 토큰 검증 → 2차 토큰 발급)
        function preparePayment(reservationToken, accessToken) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = '결제 준비 중...';

            const payload = {
                reservationToken: reservationToken
            }

            fetch('http://localhost:8081/api/v1/payments/prepare', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reservationToken: reservationToken })
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then((err) => {
                            throw new Error('결제 준비 실패: ' + (err.message || 'UNKNOWN_ERROR'));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.approvalToken) {
                        resultDiv.innerText = '결제 페이지로 이동합니다...';
                        // 2초 후 실제 결제 진행 (Mock 결제)
                        setTimeout(() => confirmPayment(data.approvalToken, accessToken), 3000);
                    } else {
                        throw new Error(data.message || '결제 준비에 실패했습니다.');
                    }
                })
                .catch(error => {
                    resultDiv.innerText = '결제 오류: ' + error.message;
                    console.error('Prepare Error:', error);
                });
        }

        // 결제 완료 후
        function  confirmPayment(token, accessToken) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = '결제 요청 중...';

            const tokenPayload = {
                reservationToken: token
            }
            fetch('http://localhost:8081/api/v1/payments/confirm',{
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tokenPayload)
            })
                .then(response => {
                    if(!response.ok) {
                        return response.json().then((err) => {throw new Error('결제 요청에 오류가 발생했습니다. error: ' + (err.reason || 'UNKNOWN_ERROR'));});
                    }
                    return response.json
                })
                .then(data => {
                    resultDiv.innerText = "결제에 성공하셨습니다! 상품을 곧 받아 보실 수 있으십니다!";
                })
                .catch(error => {
                    resultDiv.innerText = "결제 요청 중 오류가 발생했습니다.";
                    console.log(error);
                });
        }

        document.getElementById('entryButton').addEventListener('click', function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = '응모 요청 중...';

            const accessToken = common.getCookie('accessToken');

            if (!accessToken) {
                resultDiv.innerText = '오류: 로그인 정보가 없습니다.';
                return;
            }

            const eventData = {
                campaignActivityId: parseInt(campaignActivityId),
                campaignActivityType: "FIRST_COME_FIRST_SERVE",
                productId: parseInt(campaignActivityId)
            };

            fetch('http://localhost:8081/api/v1/entries', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => {
                if(response.ok) {return response.json();}
                return response.json().then(err => {
                    const reason = err.reason || '알 수 없는 에러 발생';
                    throw new Error(`응모 실패 : ${reason}`);
                })
            })
            .then(data => {
                 const token = data.reservationToken;
                 console.log(token);
                 if(token) {
                     resultDiv.innerText = "결제 창으로 이동합니다...";
                     document.getElementById('entryButton').disabled = true;
                     // 결제 창 유도 관련 페이지 (가짜 페이지)
                     setTimeout(()=>preparePayment(token, accessToken), 1000);
                 } else {throw new Error('결제 권한이 없습니다.')}
            })
            .catch(error => {
                resultDiv.innerText = '오류가 발생했습니다: ' + error.message;
                console.error('Error:', error);
            });

        });

    </script>
</section>
</html>
