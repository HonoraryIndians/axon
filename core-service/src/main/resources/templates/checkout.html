<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/default}">

<head>
    <title>SKU STORE - Checkout</title>
</head>

<body>
    <div layout:fragment="content" class="w-full max-w-[800px] mx-auto px-4 py-12">

        <h1 class="text-3xl font-black mb-10 text-center">주문/결제</h1>

        <!-- Order Summary -->
        <div class="mb-10">
            <h2 class="text-lg font-bold mb-4 border-b-2 border-black pb-2">주문 상품 정보</h2>
            <div class="flex gap-6 items-center py-4 border-b border-[#eee]">
                <div class="w-24 h-24 bg-[#f4f4f4] rounded-sm overflow-hidden">
                    <img th:src="${product.imageUrl}" class="w-full h-full object-cover" alt="product">
                </div>
                <div class="flex-1">
                    <span class="text-xs font-bold text-gray mb-1 block" th:text="${product.brand}">Brand</span>
                    <h3 class="text-base font-medium text-black mb-1" th:text="${product.name}">Product Name</h3>
                    <p class="text-sm text-gray">옵션: Free Size / 1개</p>
                </div>
                <div class="text-right">
                    <span class="text-lg font-bold text-black" th:text="${product.price} + '원'">Price</span>
                </div>
            </div>
        </div>

        <!-- Shipping Info -->
        <div class="mb-10">
            <h2 class="text-lg font-bold mb-4 border-b-2 border-black pb-2">배송지 정보</h2>
            <div class="space-y-4">
                <div class="flex items-center">
                    <label class="w-32 text-sm font-bold text-dark-gray">받는 분</label>
                    <input type="text"
                        class="flex-1 h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm"
                        placeholder="이름을 입력하세요">
                </div>
                <div class="flex items-center">
                    <label class="w-32 text-sm font-bold text-dark-gray">연락처</label>
                    <div class="flex-1 flex gap-2">
                        <input type="text"
                            class="w-20 h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm text-center"
                            value="010">
                        <span class="self-center">-</span>
                        <input type="text"
                            class="flex-1 h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm">
                        <span class="self-center">-</span>
                        <input type="text"
                            class="flex-1 h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm">
                    </div>
                </div>
                <div class="flex items-start">
                    <label class="w-32 text-sm font-bold text-dark-gray mt-2">주소</label>
                    <div class="flex-1 space-y-2">
                        <div class="flex gap-2">
                            <input type="text"
                                class="w-32 h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm"
                                placeholder="우편번호">
                            <button
                                class="h-10 px-4 border border-[#ddd] bg-[#f8f8f8] text-sm font-bold hover:bg-[#eee]">주소검색</button>
                        </div>
                        <input type="text"
                            class="w-full h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm"
                            placeholder="기본 주소">
                        <input type="text"
                            class="w-full h-10 border border-[#ddd] px-3 text-sm focus:border-black outline-none rounded-sm"
                            placeholder="상세 주소">
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for JavaScript -->
        <input type="hidden" id="original-price" th:value="${product.rawPrice}" />
        <input type="hidden" id="product-id" th:value="${product.id}" />

        <!-- Coupon Section -->
        <div class="mb-10">
            <h2 class="text-lg font-bold mb-4 border-b-2 border-black pb-2">쿠폰 할인</h2>
            <div class="flex gap-3 items-center">
                <select id="coupon-select"
                    class="flex-1 h-12 border border-[#ddd] px-3 focus:border-black outline-none rounded-sm bg-white">
                    <option value="">쿠폰을 선택해주세요</option>
                    <option th:each="coupon : ${coupons}" th:value="${coupon.userCouponId}"
                        th:data-discount="${coupon.calculatedDiscount}"
                        th:text="|${coupon.couponName} (${#numbers.formatInteger(coupon.calculatedDiscount, 0, 'COMMA')}원 할인)|">
                    </option>
                </select>
            </div>
        </div>

        <!-- Payment Summary -->
        <div class="mb-10 bg-gray-50 p-6 rounded-sm">
            <div class="flex justify-between mb-2">
                <span class="text-gray-600">주문금액</span>
                <span class="font-bold" th:text="${product.price} + '원'">Price</span>
            </div>
            <div class="flex justify-between mb-4">
                <span class="text-gray-600">할인금액</span>
                <span class="font-bold text-accent" id="discount-amount-display">-0원</span>
            </div>
            <div class="flex justify-between border-t border-gray-200 pt-4">
                <span class="text-lg font-bold text-black">총 결제금액</span>
                <span class="text-xl font-black text-black" id="total-amount-display"
                    th:text="${product.price} + '원'">Total</span>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="mb-12">
            <h2 class="text-lg font-bold mb-4 border-b-2 border-black pb-2">결제 수단</h2>
            <div class="grid grid-cols-3 gap-3">
                <button
                    class="h-12 border border-black bg-black text-white font-bold text-sm rounded-sm">신용/체크카드</button>
                <button
                    class="h-12 border border-[#ddd] bg-white text-dark-gray font-bold text-sm hover:border-black rounded-sm">무통장입금</button>
                <button
                    class="h-12 border border-[#ddd] bg-white text-dark-gray font-bold text-sm hover:border-black rounded-sm">간편결제</button>
            </div>
        </div>

        <!-- Final Payment Button -->
        <div class="sticky bottom-0 bg-white py-4 border-t border-[#eee]">
            <button id="btn-pay"
                class="w-full h-14 bg-accent text-white font-black text-lg rounded-sm hover:bg-blue-600 transition-colors shadow-lg flex justify-center items-center gap-2">
                <span class="price-text" th:text="${product.price} + '원'">Price</span>
                <span>결제하기</span>
            </button>
        </div>

    </div>

    </div>

    <th:block layout:fragment="script">
        <script>
            (function () {
                'use strict';

                // Wait for DOM to be fully loaded
                window.addEventListener('load', function () {
                    console.log('Page loaded, initializing coupon script...');

                    // Get elements
                    var originalPriceEl = document.getElementById('original-price');
                    var couponSelect = document.getElementById('coupon-select');
                    var discountDisplay = document.getElementById('discount-amount-display');
                    var totalDisplay = document.getElementById('total-amount-display');
                    var priceText = document.querySelector('.price-text');

                    // Check all elements exist
                    if (!originalPriceEl) {
                        console.error('original-price element not found!');
                        return;
                    }
                    if (!couponSelect) {
                        console.error('coupon-select element not found!');
                        return;
                    }
                    if (!discountDisplay) {
                        console.error('discount-amount-display element not found!');
                        return;
                    }
                    if (!totalDisplay) {
                        console.error('total-amount-display element not found!');
                        return;
                    }
                    if (!priceText) {
                        console.error('price-text element not found!');
                        return;
                    }

                    var originalPrice = parseFloat(originalPriceEl.value);
                    var payButton = document.getElementById('btn-pay');

                    // Coupon selection handler
                    couponSelect.onchange = function () {

                        var selectedOption = couponSelect.options[couponSelect.selectedIndex];
                        var discount = 0;

                        if (selectedOption.value !== '') {
                            discount = parseFloat(selectedOption.getAttribute('data-discount')) || 0;
                            console.log('Selected coupon discount:', discount);
                        }

                        var finalPrice = originalPrice - discount;
                        if (finalPrice < 0) finalPrice = 0;

                        // Format numbers
                        var discountFormatted = Math.round(discount).toLocaleString('ko-KR');
                        var priceFormatted = Math.round(finalPrice).toLocaleString('ko-KR');

                        // Update UI
                        discountDisplay.textContent = '-' + discountFormatted + '원';
                        totalDisplay.textContent = priceFormatted + '원';
                        priceText.textContent = priceFormatted + '원';

                    };

                    // Payment button handler
                    payButton.onclick = function () {
                        var selectedOption = couponSelect.options[couponSelect.selectedIndex];
                        var selectedCouponId = selectedOption.value;

                        // Calculate final price with discount
                        var discount = 0;
                        if (selectedCouponId !== '') {
                            discount = parseFloat(selectedOption.getAttribute('data-discount')) || 0;
                        }
                        var finalPrice = originalPrice - discount;
                        if (finalPrice < 0) finalPrice = 0;

                        // Get product ID
                        var productId = document.getElementById('product-id').value;

                        // Build URL with required parameters
                        var url = '/payment/success?productId=' + encodeURIComponent(productId) +
                                  '&finalPrice=' + encodeURIComponent(finalPrice);
                        if (selectedCouponId !== '') {
                            url += '&couponId=' + encodeURIComponent(selectedCouponId);
                        }

                        console.log('Redirecting to:', url);
                        window.location.href = url;
                    };

                });
            })();
        </script>
    </th:block>
</body>

</html>